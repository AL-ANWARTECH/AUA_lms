{% extends 'base.html' %}

{% block title %}Analytics - {{ student.username }} - AUA LMS{% endblock %}

{% block content %}
<style>
    /* Metric Cards */
    .stat-card {
        border: none;
        border-radius: 12px;
        padding: 1.5rem;
        background: white;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        border-left: 5px solid transparent;
        height: 100%;
        transition: transform 0.2s;
    }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-primary { border-left-color: #0d6efd; }
    .stat-success { border-left-color: #198754; }
    .stat-info { border-left-color: #0dcaf0; }
    .stat-warning { border-left-color: #ffc107; }

    /* Print Styles */
    @media print {
        .no-print { display: none !important; }
        .card { box-shadow: none !important; border: 1px solid #ddd !important; }
        body { background-color: white !important; }
    }
</style>

<div class="row mb-4 align-items-center">
    <div class="col-md-8">
        <nav aria-label="breadcrumb" class="no-print">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'instructor_dashboard' %}">Dashboard</a></li>
                <li class="breadcrumb-item active">Student Report</li>
            </ol>
        </nav>
        <h2 class="fw-bold text-primary mb-0">
            <i class="bi bi-person-lines-fill me-2"></i>{{ student.get_full_name|default:student.username }}
        </h2>
        <p class="text-muted mb-0">Performance Overview Report</p>
    </div>
    <div class="col-md-4 text-md-end mt-3 mt-md-0 no-print">
        <button onclick="window.print()" class="btn btn-outline-secondary">
            <i class="bi bi-printer me-2"></i>Print Report
        </button>
    </div>
</div>

<div class="row g-4 mb-5">
    <div class="col-md-4">
        <div class="stat-card stat-primary">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <p class="text-muted text-uppercase fw-bold small mb-1">Total Enrolled</p>
                    <h2 class="fw-bold mb-0">{{ total_courses }}</h2>
                    <span class="small text-muted">Courses</span>
                </div>
                <div class="bg-primary bg-opacity-10 text-primary rounded p-2">
                    <i class="bi bi-journal-bookmark-fill fs-4"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card stat-success">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <p class="text-muted text-uppercase fw-bold small mb-1">Completed</p>
                    <h2 class="fw-bold mb-0">{{ completed_courses }}</h2>
                    <span class="small text-muted">Courses Finished</span>
                </div>
                <div class="bg-success bg-opacity-10 text-success rounded p-2">
                    <i class="bi bi-trophy-fill fs-4"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card stat-info">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <p class="text-muted text-uppercase fw-bold small mb-1">Avg. Progress</p>
                    <h2 class="fw-bold mb-0">{{ average_progress|floatformat:0 }}%</h2>
                    <span class="small text-muted">Across all courses</span>
                </div>
                <div class="bg-info bg-opacity-10 text-info rounded p-2">
                    <i class="bi bi-bar-chart-fill fs-4"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-7 mb-4">
        
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-3">
                <h5 class="fw-bold mb-0">Progress Visualization</h5>
            </div>
            <div class="card-body">
                <canvas id="progressChart" height="150"></canvas>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <h5 class="fw-bold mb-0">Course Details</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">Course Name</th>
                                <th style="width: 30%;">Progress</th>
                                <th class="text-center">Lessons</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for data in course_data %}
                                <tr>
                                    <td class="ps-4 fw-bold text-secondary">{{ data.course }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                                <div class="progress-bar {% if data.progress >= 100 %}bg-success{% else %}bg-primary{% endif %}" 
                                                     role="progressbar" 
                                                     style="width: {{ data.progress|stringformat:'f' }}%">
                                                </div>
                                            </div>
                                            <span class="small fw-bold">{{ data.progress|floatformat:0 }}%</span>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-light text-dark border">
                                            {{ data.completed_lessons }} / {{ data.total_lessons }}
                                        </span>
                                    </td>
                                </tr>
                            {% empty %}
                                <tr><td colspan="3" class="text-center py-4 text-muted">No course data found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-5">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white py-3">
                <h5 class="fw-bold mb-0">Recent Grades</h5>
            </div>
            <div class="card-body p-0">
                {% if grades %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-3">Item</th>
                                    <th class="text-center">Score</th>
                                    <th class="text-end pe-3">Result</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for grade in grades %}
                                    <tr>
                                        <td class="ps-3">
                                            <div class="fw-bold text-dark mb-0">{{ grade.grade_type|title }}</div>
                                            <small class="text-muted d-block text-truncate" style="max-width: 150px;">
                                                {{ grade.enrollment.course.title }}
                                            </small>
                                        </td>
                                        <td class="text-center">
                                            <span class="text-dark fw-bold">{{ grade.score }}</span>
                                            <span class="text-muted small">/{{ grade.max_points }}</span>
                                        </td>
                                        <td class="text-end pe-3">
                                            {% if grade.percentage >= 80 %}
                                                <span class="badge bg-success bg-opacity-10 text-success rounded-pill">Excellent</span>
                                            {% elif grade.percentage >= 60 %}
                                                <span class="badge bg-warning bg-opacity-10 text-warning rounded-pill">Good</span>
                                            {% else %}
                                                <span class="badge bg-danger bg-opacity-10 text-danger rounded-pill">Needs Work</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-clipboard-x display-4 text-muted opacity-25"></i>
                        <p class="text-muted mt-3">No grades recorded yet.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{{ course_data|json_script:"course-progress-data" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const rawData = JSON.parse(document.getElementById('course-progress-data').textContent);
        
        const labels = rawData.map(item => item.course);
        const dataPoints = rawData.map(item => item.progress);

        const ctx = document.getElementById('progressChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Course Progress (%)',
                    data: dataPoints,
                    backgroundColor: 'rgba(13, 110, 253, 0.7)',
                    borderColor: 'rgba(13, 110, 253, 1)',
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    },
                    x: {
                        ticks: {
                            autoSkip: false,
                            maxRotation: 45,
                            minRotation: 0
                        }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    });
</script>
{% endblock %}